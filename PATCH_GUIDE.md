# 增量更新指南 (保留配置)

本指南介绍如何使用 `deploy_patch.sh` 脚本将今天的代码更改同步到服务器，**同时严格保护您现有的数据库和配置文件**。

## 适用场景

*   您已经使用 `deploy_kylin_py39.sh` 成功部署过服务器。
*   您只想更新今天的代码更改（管理员资源管理、运行时间统计）。
*   您**不希望**覆盖 `.env` 配置文件或重置数据库。
*   您的服务器无法连接 GitHub。

## 使用方法

1.  **确保本地环境准备就绪**
    确保您本地安装了 Node.js (用于构建前端)。

2.  **运行更新脚本**
    在项目根目录下执行：

    ```bash
    ./deploy_patch.sh <您的服务器IP>
    ```

    例如：
    ```bash
    ./deploy_patch.sh 192.168.100.105
    ```

## 脚本原理解析

为了让您放心，以下是该脚本执行的具体操作：

1.  **本地构建前端**：
    *   在您的电脑上运行 `npm run build` 生成静态文件。
    *   **安全点**：不依赖服务器的网络环境。

2.  **同步后端代码**：
    *   使用 `rsync` 将 `backend/` 目录同步到服务器。
    *   **关键保护**：脚本明确排除了 `.env` (配置文件)、`venv` (虚拟环境)、`media` (上传文件) 和 `staticfiles`。
    *   **结果**：只有 `.py` 代码文件会被更新，您的配置完全不受影响。

3.  **同步前端资源**：
    *   将本地生成的 `frontend/build/` 文件夹上传到服务器对应目录。
    *   **结果**：界面更新，但 Nginx 配置保持不变。

4.  **重启服务**：
    *   执行 `systemctl restart gunicorn celery celerybeat`。
    *   **结果**：后端加载新代码，服务短暂重启。

## 验证更新

更新完成后，请登录系统验证：
1.  **管理员**：Dashboard 是否有"为租户建系统"按钮。
2.  **租户**：列表是否显示"运行时长"。
